<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Lagged Training Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f6f8fb;
      --fg: #1f2a40;
      --accent: #1f78d1;
      --card-bg: #ffffff;
      --border: #d8e1ee;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, sans-serif;
      background: var(--bg);
      color: var(--fg);
    }

    header {
      background: var(--accent);
      color: #fff;
      padding: 1.5rem 2rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
    }

    main {
      padding: 2rem;
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      gap: 1.5rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.08);
      border: 1px solid var(--border);
    }

    h2 {
      margin-top: 0;
      font-size: 1.25rem;
    }

    .form-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #475569;
      margin-bottom: 0.5rem;
      display: block;
    }

    input, select {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 1rem;
      background: #fff;
      box-sizing: border-box;
    }

    button {
      padding: 0.6rem 1rem;
      border-radius: 8px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(31, 120, 209, 0.22);
    }

    pre {
      background: #0f172a;
      color: #e2e8f0;
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 0.9rem;
      max-height: 400px;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #16a34a;
      display: inline-block;
    }

    @media (max-width: 640px) {
      main {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Lagged Training Dashboard</h1>
    <p>Interact with the lagged simulation API and monitor historical summaries.</p>
  </header>
  <main>
    <section class="card">
      <div class="status">
        <span class="status-dot" id="status-dot"></span>
        <span id="status-text">Checking backend status...</span>
      </div>
    </section>

    <section class="card">
      <h2>Scenario Snapshot</h2>
      <form id="scenario-form">
        <div class="form-grid">
          <div>
            <label for="scenario-date">Date (YYYY-MM-DD)</label>
            <input id="scenario-date" name="date" type="date" required>
          </div>
          <div>
            <label for="scenario-nodes">Nodes (comma separated)</label>
            <input id="scenario-nodes" name="nodes" placeholder="HB_WEST,HB_NORTH">
          </div>
          <div>
            <label for="scenario-topk">Top Constraints</label>
            <input id="scenario-topk" name="top_constraints" type="number" min="1" value="3">
          </div>
          <div>
            <label for="scenario-liquidity">Liquidity (b)</label>
            <input id="scenario-liquidity" name="liquidity" type="number" step="0.1" value="5.0">
          </div>
        </div>
        <div style="margin-top: 1rem;">
          <button type="submit">Fetch Summary</button>
        </div>
      </form>
      <pre id="scenario-output">{}</pre>
    </section>

    <section class="card">
      <h2>Trade Suggestions</h2>
      <form id="trades-form">
        <div class="form-grid">
          <div>
            <label for="trades-date">Date (YYYY-MM-DD)</label>
            <input id="trades-date" name="date" type="date" required>
          </div>
          <div>
            <label for="trades-hub">Hub</label>
            <input id="trades-hub" name="hub" value="HB_HOUSTON">
          </div>
          <div>
            <label for="trades-nodes">Nodes (comma separated)</label>
            <input id="trades-nodes" name="nodes" value="HB_WEST,HB_NORTH">
          </div>
          <div>
            <label for="trades-policy">Policy</label>
            <select id="trades-policy" name="policy">
              <option value="cvar">CVaR</option>
              <option value="maxent">MaxEnt</option>
            </select>
          </div>
          <div>
            <label for="trades-risk">Risk Budget</label>
            <input id="trades-risk" name="risk_budget" type="number" step="1" value="1000">
          </div>
          <div>
            <label for="trades-delta">Scenario Δ</label>
            <input id="trades-delta" name="scenario_delta" type="number" step="0.1" value="15">
          </div>
          <div>
            <label for="trades-alpha">CVaR α</label>
            <input id="trades-alpha" name="cvar_alpha" type="number" step="0.01" value="0.95">
          </div>
          <div>
            <label for="trades-maxq">Max Quantity</label>
            <input id="trades-maxq" name="max_quantity" type="number" step="1" value="200">
          </div>
        </div>
        <div style="margin-top: 1rem;">
          <button type="submit">Compute Trades</button>
        </div>
      </form>
      <pre id="trades-output">{}</pre>
    </section>

    <section class="card">
      <h2>Training Run</h2>
      <form id="train-form">
        <div class="form-grid">
          <div>
            <label for="train-date">Date (YYYY-MM-DD)</label>
            <input id="train-date" name="date" type="date" required>
          </div>
          <div>
            <label for="train-hub">Hub</label>
            <input id="train-hub" name="hub" value="HB_HOUSTON">
          </div>
          <div>
            <label for="train-nodes">Nodes (comma separated)</label>
            <input id="train-nodes" name="nodes" value="HB_WEST,HB_NORTH">
          </div>
          <div>
            <label for="train-policy">Policy</label>
            <select id="train-policy" name="policy">
              <option value="cvar">CVaR</option>
              <option value="maxent">MaxEnt</option>
            </select>
          </div>
          <div>
            <label for="train-risk-budget">Risk Budget</label>
            <input id="train-risk-budget" name="risk_budget" type="number" step="1" value="1000">
          </div>
          <div>
            <label for="train-risk-aversion">Risk Aversion</label>
            <input id="train-risk-aversion" name="risk_aversion" type="number" step="0.1" value="1.0">
          </div>
          <div>
            <label for="train-delta">Scenario Δ</label>
            <input id="train-delta" name="scenario_delta" type="number" step="0.1" value="15">
          </div>
          <div>
            <label for="train-alpha">CVaR α</label>
            <input id="train-alpha" name="cvar_alpha" type="number" step="0.01" value="0.95">
          </div>
          <div>
            <label for="train-maxq">Max Quantity</label>
            <input id="train-maxq" name="max_quantity" type="number" step="1" value="200">
          </div>
          <div>
            <label for="train-temp">Temperature</label>
            <input id="train-temp" name="temperature" type="number" step="0.1" value="50">
          </div>
          <div>
            <label for="train-prob-base">Prob Base</label>
            <input id="train-prob-base" name="prob_base" type="number" step="0.01" placeholder="0.5">
          </div>
          <div>
            <label for="train-prob-up">Prob Up</label>
            <input id="train-prob-up" name="prob_up" type="number" step="0.01" placeholder="0.25">
          </div>
          <div>
            <label for="train-prob-down">Prob Down</label>
            <input id="train-prob-down" name="prob_down" type="number" step="0.01" placeholder="0.25">
          </div>
        </div>
        <div style="margin-top: 1rem;">
          <label for="train-notes">Notes</label>
          <textarea id="train-notes" name="notes" rows="3" style="width:100%; border-radius:8px; border:1px solid var(--border);"></textarea>
        </div>
        <div style="margin-top: 1rem;">
          <button type="submit">Run Training</button>
        </div>
      </form>
      <pre id="train-output">{}</pre>
    </section>
  </main>

  <script>
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const scenarioForm = document.getElementById('scenario-form');
    const tradesForm = document.getElementById('trades-form');
    const trainForm = document.getElementById('train-form');
    const scenarioOutput = document.getElementById('scenario-output');
    const tradesOutput = document.getElementById('trades-output');
    const trainOutput = document.getElementById('train-output');

    async function fetchJSON(url, options = {}) {
      const response = await fetch(url, options);
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.error || response.statusText);
      }
      return data;
    }

    function toISO(date) {
      if (!date) return '';
      const d = new Date(date);
      if (Number.isNaN(d.getTime())) return '';
      return d.toISOString().slice(0, 10);
    }

    async function refreshStatus() {
      try {
        const data = await fetchJSON('/api/status');
        statusDot.style.background = '#16a34a';
        statusText.textContent = `API OK · path=${data.db_path} · pool=${data.pool_size}`;
        const yesterday = new Date();
        yesterday.setUTCDate(yesterday.getUTCDate() - 1);
        const iso = toISO(yesterday);
        scenarioForm.date.value = iso;
        tradesForm.date.value = iso;
        trainForm.date.value = iso;
      } catch (err) {
        statusDot.style.background = '#dc2626';
        statusText.textContent = `API error: ${err.message}`;
      }
    }

    function parseNodes(value) {
      if (!value) return undefined;
      return value.split(',').map(v => v.trim()).filter(Boolean);
    }

    function parseScenarioProbs(form) {
      const base = form.get('prob_base');
      const up = form.get('prob_up');
      const down = form.get('prob_down');
      if ((!base || base === '') && (!up || up === '') && (!down || down === '')) {
        return undefined;
      }
      return {
        base: base ? Number(base) : 0.5,
        up: up ? Number(up) : 0.25,
        down: down ? Number(down) : 0.25,
      };
    }

    scenarioForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const form = new FormData(scenarioForm);
      const body = {
        date: form.get('date'),
        top_constraints: Number(form.get('top_constraints')),
        liquidity: Number(form.get('liquidity')),
      };
      const nodes = parseNodes(form.get('nodes'));
      if (nodes && nodes.length) {
        body.nodes = nodes;
      }
      try {
        scenarioOutput.textContent = 'Loading…';
        const data = await fetchJSON('/api/simulate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        scenarioOutput.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        scenarioOutput.textContent = JSON.stringify({ error: err.message }, null, 2);
      }
    });

    tradesForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const form = new FormData(tradesForm);
      const body = {
        date: form.get('date'),
        hub: form.get('hub'),
        policy: form.get('policy'),
        risk_budget: Number(form.get('risk_budget')),
        scenario_delta: Number(form.get('scenario_delta')),
        cvar_alpha: Number(form.get('cvar_alpha')),
        max_quantity: Number(form.get('max_quantity')),
      };
      const nodes = parseNodes(form.get('nodes'));
      if (nodes && nodes.length) {
        body.nodes = nodes;
      }
      try {
        tradesOutput.textContent = 'Loading…';
        const data = await fetchJSON('/api/trades', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        tradesOutput.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        tradesOutput.textContent = JSON.stringify({ error: err.message }, null, 2);
      }
    });

    trainForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const form = new FormData(trainForm);
      const body = {
        date: form.get('date'),
        hub: form.get('hub'),
        policy: form.get('policy'),
        risk_budget: Number(form.get('risk_budget')),
        risk_aversion: Number(form.get('risk_aversion')),
        scenario_delta: Number(form.get('scenario_delta')),
        cvar_alpha: Number(form.get('cvar_alpha')),
        max_quantity: Number(form.get('max_quantity')),
        temperature: Number(form.get('temperature')),
      };
      const nodes = parseNodes(form.get('nodes'));
      if (nodes && nodes.length) {
        body.nodes = nodes;
      }
      const probs = parseScenarioProbs(form);
      if (probs) {
        body.scenario_probs = probs;
      }
      const notes = form.get('notes');
      if (notes && notes.trim().length > 0) {
        body.notes = [{ note: notes.trim() }];
      }
      try {
        trainOutput.textContent = 'Training…';
        const data = await fetchJSON('/api/train', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        trainOutput.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        trainOutput.textContent = JSON.stringify({ error: err.message }, null, 2);
      }
    });

    refreshStatus();
  </script>
</body>
</html>
